name: OSINT Security & Dependency Scan

on:
  push:
    branches: [main, develop, hotfix/**]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'  # Weekly scan

permissions:
  id-token: write
  contents: write

jobs:
  dependency-submission:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Component Detection & Dependency Submission
      uses: actions/component-detection-dependency-submission-action@main
      with:
        filePath: '.'
        detectorsFilter: 'Pip,Npm'  # Focus on Python and Node.js
        detectorArgs: 'Pip=EnableIfDefaultOff'
        correlator: 'handy-reaper-osint'

  security-scan:
    runs-on: ubuntu-latest
    needs: dependency-submission
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp dnspython bandit safety pip-audit
    
    - name: Run security scans
      run: |
        echo "üîç Running security scans..."
        bandit -r . -f json -o bandit-report.json || echo "Bandit completed"
        safety check --json --output safety-report.json || echo "Safety completed"
        pip-audit --format json --output pip-audit-report.json || echo "pip-audit completed"

  osint-functionality:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    
    - name: Install and test
      run: |
        pip install aiohttp dnspython
        python -m py_compile main.py
        python -c "
        import sys
        sys.path.append('.')
        from main import EnhancedOSINTSystem
        print('‚úÖ OSINT system imports correctly')
        "

  upload-reports:
    runs-on: ubuntu-latest
    needs: [security-scan, osint-functionality]
    steps:
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          pip-audit-report.json
        retention-days: 30

name: OSINT Security Scan

on: [push, pull_request]

jobs:
  security-analysis:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp dnspython pylint bandit safety pip-audit
        
    - name: Code analysis with Pylint
      run: |
        pylint $(git ls-files '*.py') --exit-zero
    
    - name: Security scan with Bandit
      run: |
        bandit -r . -f json -o bandit-results.json || true
    
    - name: Vulnerability check with Safety
      run: |
        safety check --json --output safety-report.json || true
    
    - name: Dependency audit with pip-audit
      run: |
        pip-audit --format json --output pip-audit-report.json || true

  core-functionality:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    
    - name: Install dependencies
      run: |
        pip install aiohttp dnspython
    
    - name: Test basic imports and structure
      run: |
        python -c "
        import sys
        import os
        
        print('üîç Checking Python files...')
        python_files = [f for f in os.listdir('.') if f.endswith('.py')]
        print(f'Found Python files: {python_files}')
        
        if not python_files:
            print('‚ùå No Python files found!')
            sys.exit(1)
        
        # Test syntax of all Python files
        for py_file in python_files:
            try:
                with open(py_file, 'r') as f:
                    source_code = f.read()
                compile(source_code, py_file, 'exec')
                print(f'‚úì {py_file} - Syntax valid')
            except SyntaxError as e:
                print(f'‚ùå {py_file} - Syntax error: {e}')
                sys.exit(1)
            except Exception as e:
                print(f'‚ö†Ô∏è  {py_file} - Could not check: {e}')
        
        print('‚úÖ All Python files have valid syntax')
        "

  syntax-validation:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    
    - name: Validate Python syntax
      run: |
        echo "üîç Validating Python syntax..."
        python_files=$(find . -name "*.py" -type f)
        
        if [ -z \"$python_files\" ]; then
          echo "‚ùå No Python files found!"
          exit 1
        fi
        
        echo "Found files:"
        echo "$python_files"
        echo ""
        
        error_count=0
        for file in $python_files; do
          echo "Checking $file..."
          if python -m py_compile \"$file\"; then
            echo \"  ‚úì Syntax valid\"
          else
            echo \"  ‚ùå Syntax error\"
            error_count=$((error_count + 1))
          fi
        done
        
        if [ $error_count -eq 0 ]; then
          echo \"‚úÖ All Python files have valid syntax\"
        else
          echo \"‚ùå $error_count file(s) have syntax errors\"
          exit 1
        fi

  basic-import-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    
    - name: Test core imports
      run: |
        python -c "
        print('üß™ Testing core imports...')
        try:
            import asyncio
            print('‚úì asyncio')
        except ImportError as e:
            print(f'‚ùå asyncio: {e}')
        
        try:
            import aiohttp
            print('‚úì aiohttp')
        except ImportError as e:
            print(f'‚ùå aiohttp: {e}')
        
        try:
            import dns.resolver
            print('‚úì dnspython')
        except ImportError as e:
            print(f'‚ùå dnspython: {e}')
        
        try:
            import argparse
            print('‚úì argparse')
        except ImportError as e:
            print(f'‚ùå argparse: {e}')
        
        print('‚úÖ Core import test completed')
        "

  file-structure:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check repository structure
      run: |
        echo \"üìÅ Repository Structure:\"
        find . -name \"*.py\" -type f | head -10
        echo \"\"
        echo \"üìä File Count:\"
        echo \"Python files: $(find . -name '*.py' -type f | wc -l)\"
        echo \"Total files: $(find . -type f | wc -l)\"
        
        # Check for required files
        if [ -f \"README.md\" ]; then
          echo \"‚úì README.md found\"
        else
          echo \"‚ö†Ô∏è  README.md missing\"
        fi
        
        if [ -f \"main.py\" ] || [ -f \"handy_reaper.py\" ]; then
          echo \"‚úì Main Python file found\"
        else
          echo \"‚ùå No main Python file found\"
          exit 1
        fi

  osint-pattern-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for OSINT patterns
      run: |
        echo \"üîç Checking for OSINT patterns...\"
        
        # Check for common OSINT-related patterns
        patterns_found=0
        
        if find . -name \"*.py\" -exec grep -l \"platforms.*social.*media\" {} \; | grep -q .; then
            echo \"‚úì Social media platform patterns\"
            patterns_found=$((patterns_found + 1))
        fi
        
        if find . -name \"*.py\" -exec grep -l \"async.*def.*scan\" {} \; | grep -q .; then
            echo \"‚úì Async scanning patterns\"
            patterns_found=$((patterns_found + 1))
        fi
        
        if find . -name \"*.py\" -exec grep -l \"rate.*limit\" {} \; | grep -q .; then
            echo \"‚úì Rate limiting patterns\"
            patterns_found=$((patterns_found + 1))
        fi
        
        if find . -name \"*.py\" -exec grep -l \"proxy.*config\" {} \; | grep -q .; then
            echo \"‚úì Proxy configuration patterns\"
            patterns_found=$((patterns_found + 1))
        fi
        
        if find . -name \"*.py\" -exec grep -l \"dns.*resolver\" {} \; | grep -q .; then
            echo \"‚úì DNS analysis patterns\"
            patterns_found=$((patterns_found + 1))
        fi
        
        echo \"\"
        if [ $patterns_found -ge 3 ]; then
          echo \"‚úÖ Strong OSINT patterns detected ($patterns_found/5)\"
        elif [ $patterns_found -ge 1 ]; then
          echo \"‚ö†Ô∏è  Basic OSINT patterns detected ($patterns_found/5)\"
        else
          echo \"‚ùå No OSINT patterns detected\"
          exit 1
        fi

  upload-reports:
    runs-on: ubuntu-latest
    needs: [security-analysis]
    if: always()
    steps:
    - name: Download security reports
      uses: actions/download-artifact@v3
      with:
        path: security-reports
    
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-analysis-reports
        path: security-reports
        retention-days: 30

  final-report:
    runs-on: ubuntu-latest
    needs: [security-analysis, core-functionality, syntax-validation, basic-import-test, file-structure, osint-pattern-check]
    if: always()
    steps:
    - name: Generate comprehensive report
      run: |
        echo \"# üöÄ HANDY REAPER CI Validation Report\"
        echo \"\"
        echo \"## üìä Test Results Summary\"
        echo \"| Test | Status | Details |\"
        echo \"|------|--------|---------|\"
        echo \"| Security Analysis | ${{ needs.security-analysis.result }} | Pylint, Bandit, Safety, pip-audit |\"
        echo \"| Core Functionality | ${{ needs.core-functionality.result }} | Syntax validation |\"
        echo \"| Syntax Validation | ${{ needs.syntax-validation.result }} | Python compilation |\"
        echo \"| Basic Import Test | ${{ needs.basic-import-test.result }} | Core dependencies |\"
        echo \"| File Structure | ${{ needs.file-structure.result }} | Repository layout |\"
        echo \"| OSINT Patterns | ${{ needs.osint-pattern-check.result }} | Feature detection |\"
        echo \"\"
        echo \"## üéØ Next Steps\"
        
        if [ '${{ needs.security-analysis.result }}' = 'success' ]; then
          echo \"‚úÖ Security checks completed - review reports in artifacts\"
        else
          echo \"üìã Security analysis had issues - check workflow logs\"
        fi
        
        if [ '${{ needs.syntax-validation.result }}' = 'success' ]; then
          echo \"‚úÖ All Python files have valid syntax\"
        else
          echo \"‚ùå Syntax errors found - fix before proceeding\"
        fi
        
        if [ '${{ needs.osint-pattern-check.result }}' = 'success' ]; then
          echo \"‚úÖ OSINT features properly implemented\"
        else
          echo \"‚ö†Ô∏è  Review OSINT pattern implementation\"
        fi
        
        echo \"\"
        echo \"---\"
        echo \"*HANDY REAPER OSINT System - CI Validation Complete*\"
        
        # Overall status
        if [ '${{ needs.security-analysis.result }}' = 'success' ] && \
           [ '${{ needs.syntax-validation.result }}' = 'success' ] && \
           [ '${{ needs.osint-pattern-check.result }}' = 'success' ]; then
          echo \"\"  
          echo \"üéâ ALL CRITICAL CHECKS PASSED - READY FOR DEPLOYMENT!\"
        else
          echo \"\"
          echo \"‚ö†Ô∏è  SOME CHECKS NEED ATTENTION - REVIEW LOGS\"
        fi

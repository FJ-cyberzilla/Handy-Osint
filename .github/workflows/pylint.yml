name: OSINT Security Scan

on: [push, pull_request]

jobs:
  security-analysis:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Find main Python file
      id: find_main
      run: |
        # Look for the main OSINT script
        if [ -f "handy_reaper.py" ]; then
          echo "main_file=handy_reaper.py" >> $GITHUB_OUTPUT
        elif [ -f "osint_system.py" ]; then
          echo "main_file=osint_system.py" >> $GITHUB_OUTPUT
        elif [ -f "main.py" ]; then
          echo "main_file=main.py" >> $GITHUB_OUTPUT
        else
          # Find first .py file that looks like main script
          MAIN_FILE=$(find . -name "*.py" -type f | head -1)
          if [ -n "$MAIN_FILE" ]; then
            echo "main_file=${MAIN_FILE#./}" >> $GITHUB_OUTPUT
          else
            echo "No Python files found"
            exit 1
          fi
        fi
        echo "Main file: ${{ steps.find_main.outputs.main_file }}"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp dnspython pylint bandit safety pip-audit
        
    - name: Code analysis with Pylint
      run: |
        pylint $(git ls-files '*.py') --exit-zero
    
    - name: Security scan with Bandit
      run: |
        bandit -r . -f json -o bandit-results.json --exit-zero
    
    - name: Vulnerability check with Safety
      run: |
        safety check --json --output safety-report.json --exit-zero
    
    - name: Dependency audit with pip-audit
      run: |
        pip-audit --format json --output pip-audit-report.json --exit-zero
    
    - name: Check for performance issues
      run: |
        python -c "
        import ast
        import sys
        import os
        
        def find_python_files():
            python_files = []
            for root, dirs, files in os.walk('.'):
                for file in files:
                    if file.endswith('.py') and not file.startswith('test_'):
                        python_files.append(os.path.join(root, file))
            return python_files
        
        def check_performance_issues(filepath):
            try:
                with open(filepath, 'r') as f:
                    tree = ast.parse(f.read())
                
                issues = []
                
                for node in ast.walk(tree):
                    # Check for sleep in loops
                    if isinstance(node, ast.While):
                        for child in ast.walk(node):
                            if isinstance(child, ast.Call):
                                if isinstance(child.func, ast.Attribute):
                                    if child.func.attr == 'sleep':
                                        issues.append(f'Sleep in loop detected in {filepath} - consider asyncio tasks')
                    
                    # Check for synchronous I/O in async functions
                    if isinstance(node, ast.AsyncFunctionDef):
                        for child in ast.walk(node):
                            if isinstance(child, ast.Call):
                                if isinstance(child.func, ast.Name):
                                    if child.func.id in ['open', 'requests.get', 'requests.post']:
                                        issues.append(f'Synchronous I/O in async function in {filepath}')
                
                return issues
            except Exception as e:
                return [f'Could not parse {filepath}: {e}']
        
        # Check all Python files
        all_issues = []
        python_files = find_python_files()
        
        if not python_files:
            print('‚ùå No Python files found!')
            sys.exit(1)
            
        print(f'üîç Analyzing {len(python_files)} Python files...')
        
        for filepath in python_files:
            issues = check_performance_issues(filepath)
            all_issues.extend(issues)
        
        if all_issues:
            print('Performance considerations:')
            for issue in all_issues:
                print(f'  ‚ö†Ô∏è  {issue}')
        else:
            print('‚úì No major performance issues detected')
        "
    
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports-${{ matrix.python-version }}
        path: |
          bandit-results.json
          safety-report.json
          pip-audit-report.json

  core-functionality:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    
    - name: Discover main application file
      id: discover_main
      run: |
        # Try to find the main entry point
        for file in *.py; do
          if [ -f "$file" ]; then
            if grep -q "def main\|if __name__.*__main__\|argparse" "$file"; then
              echo "main_file=$file" >> $GITHUB_OUTPUT
              echo "Found main file: $file"
              break
            fi
          fi
        done
        
        if [ -z '${{ steps.discover_main.outputs.main_file }}' ]; then
          # Fallback to first Python file
          FIRST_PY=$(ls *.py | head -1)
          if [ -n "$FIRST_PY" ]; then
            echo "main_file=$FIRST_PY" >> $GITHUB_OUTPUT
            echo "Using first Python file: $FIRST_PY"
          else
            echo "No Python files found"
            exit 1
          fi
        fi
    
    - name: Install dependencies
      run: |
        pip install aiohttp dnspython
    
    - name: Test basic imports
      run: |
        python -c "
        import sys
        import importlib
        
        # Try to import the main module
        main_file = '${{ steps.discover_main.outputs.main_file }}'
        module_name = main_file.replace('.py', '')
        
        try:
            # Add current directory to path
            sys.path.append('.')
            
            # Try to import the module
            spec = importlib.util.spec_from_file_location(module_name, main_file)
            module = importlib.util.module_from_spec(spec)
            spec.loader.exec_module(module)
            
            print(f'‚úì Successfully imported {main_file}')
            
            # Check for required classes
            required_classes = ['EnhancedOSINTSystem', 'DNSAnalyzer', 'RateLimiter']
            available_classes = [name for name in dir(module) if not name.startswith('_')]
            
            for req_class in required_classes:
                if hasattr(module, req_class):
                    print(f'‚úì Found required class: {req_class}')
                else:
                    print(f'‚ö†Ô∏è  Missing class: {req_class}')
                    
        except Exception as e:
            print(f'‚ùå Failed to import {main_file}: {e}')
            sys.exit(1)
        "
    
    - name: Validate syntax
      run: |
        python -m py_compile $(find . -name "*.py" -type f)
        echo "‚úì All Python files have valid syntax"

  quick-validation:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Quick file structure check
      run: |
        echo "üìÅ Repository Structure:"
        find . -name "*.py" -type f | head -10
        echo ""
        echo "üìä File Count:"
        echo "Python files: $(find . -name '*.py' -type f | wc -l)"
        echo "Total files: $(find . -type f | wc -l)"
        
        # Check for common OSINT system patterns
        if find . -name "*.py" -type f -exec grep -l "aiohttp\|dnspython\|OSINT" {} \; | grep -q .; then
            echo "‚úì OSINT patterns found in code"
        else
            echo "‚ö†Ô∏è  No obvious OSINT patterns detected"
        fi

  final-report:
    runs-on: ubuntu-latest
    needs: [security-analysis, core-functionality, quick-validation]
    if: always()
    steps:
    - name: Generate final report
      run: |
        echo "# HANDY RECON CI Report"
        echo ""
        echo "## Job Status"
        echo "- Security Analysis: ${{ needs.security-analysis.result }}"
        echo "- Core Functionality: ${{ needs.core-functionality.result }}"
        echo "- Quick Validation: ${{ needs.quick-validation.result }}"
        echo ""
        echo "## Next Steps"
        if [ '${{ needs.security-analysis.result }}' = 'success' ]; then
          echo "‚úÖ Security checks completed"
        else
          echo "üìã Review security reports in artifacts"
        fi
        
        if [ '${{ needs.core-functionality.result }}' = 'success' ]; then
          echo "‚úÖ Core functionality verified"
        else
          echo "üîß Check import and initialization issues"
        fi

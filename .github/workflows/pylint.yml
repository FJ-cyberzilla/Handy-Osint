name: OSINT Security Scan

permissions:
  contents: read

on: [push, pull_request]

jobs:
  security-analysis:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp dnspython pylint bandit safety pip-audit
        
    - name: Code analysis with Pylint
      run: |
        pylint $(git ls-files '*.py') --exit-zero
    
    - name: Security scan with Bandit
      run: |
        bandit -r . -f json -o bandit-results.json || echo "Bandit completed with findings"
    
    - name: Vulnerability check with Safety
      run: |
        safety check --json --output safety-report.json || echo "Safety completed with findings"
    
    - name: Dependency audit with pip-audit
      run: |
        pip-audit --format json --output pip-audit-report.json || echo "pip-audit completed with findings"

  syntax-validation:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    
    - name: Validate Python syntax
      run: |
        echo "Validating Python syntax..."
        # Find all Python files
        python_files=$(find . -name "*.py" -type f)
        
        if [ -z "$python_files" ]; then
          echo "No Python files found!"
          exit 1
        fi
        
        echo "Found Python files:"
        echo "$python_files"
        echo ""
        
        error_count=0
        for file in $python_files; do
          echo "Checking $file..."
          if python -m py_compile "$file"; then
            echo "  Syntax valid"
          else
            echo "  Syntax error"
            error_count=$((error_count + 1))
          fi
        done
        
        if [ $error_count -eq 0 ]; then
          echo "All Python files have valid syntax"
        else
          echo "$error_count file(s) have syntax errors"
          exit 1
        fi

  core-imports:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    
    - name: Test core imports
      run: |
        python -c "
        print('Testing core imports...')
        try:
            import asyncio
            print('✓ asyncio')
        except ImportError as e:
            print('✗ asyncio:', e)
        
        try:
            import aiohttp
            print('✓ aiohttp')
        except ImportError as e:
            print('✗ aiohttp:', e)
        
        try:
            import dns.resolver
            print('✓ dnspython')
        except ImportError as e:
            print('✗ dnspython:', e)
        
        print('Core import test completed')
        "

  file-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check repository structure
      run: |
        echo "Repository Structure:"
        find . -name "*.py" -type f
        echo ""
        echo "File Count:"
        echo "Python files: $(find . -name '*.py' -type f | wc -l)"
        echo "Total files: $(find . -type f | wc -l)"
        
        # Check for main Python file
        if find . -name "*.py" -type f | grep -q .; then
          echo "Python files found"
          MAIN_FILE=$(find . -name "*.py" -type f | head -1)
          echo "Main file: $MAIN_FILE"
        else
          echo "No Python files found"
          exit 1
        fi

  feature-detection:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for OSINT features
      run: |
        echo "Checking for OSINT features..."
        
        patterns_found=0
        
        if find . -name "*.py" -exec grep -l "platform" {} \; | grep -q .; then
            echo "✓ Platform patterns found"
            patterns_found=$((patterns_found + 1))
        fi
        
        if find . -name "*.py" -exec grep -l "async" {} \; | grep -q .; then
            echo "✓ Async patterns found"
            patterns_found=$((patterns_found + 1))
        fi
        
        if find . -name "*.py" -exec grep -l "scan" {} \; | grep -q .; then
            echo "✓ Scanning patterns found"
            patterns_found=$((patterns_found + 1))
        fi
        
        if find . -name "*.py" -exec grep -l "dns" {} \; | grep -q .; then
            echo "✓ DNS patterns found"
            patterns_found=$((patterns_found + 1))
        fi
        
        echo "OSINT patterns detected: $patterns_found/4"
        
        if [ $patterns_found -ge 2 ]; then
          echo "OSINT features confirmed"
        else
          echo "Limited OSINT patterns found"
        fi

  final-report:
    runs-on: ubuntu-latest
    needs: [security-analysis, syntax-validation, core-imports, file-check, feature-detection]
    if: always()
    steps:
    - name: Generate final report
      run: |
        echo "=== HANDY REAPER CI VALIDATION REPORT ==="
        echo ""
        echo "TEST RESULTS:"
        echo "- Security Analysis: ${{ needs.security-analysis.result }}"
        echo "- Syntax Validation: ${{ needs.syntax-validation.result }}"
        echo "- Core Imports: ${{ needs.core-imports.result }}"
        echo "- File Check: ${{ needs.file-check.result }}"
        echo "- Feature Detection: ${{ needs.feature-detection.result }}"
        echo ""
        echo "NEXT STEPS:"
        
        if [ "${{ needs.syntax-validation.result }}" = "success" ]; then
          echo "✓ Code syntax is valid"
        else
          echo "✗ Fix syntax errors first"
        fi
        
        if [ "${{ needs.core-imports.result }}" = "success" ]; then
          echo "✓ Core dependencies working"
        else
          echo "✗ Check dependency installation"
        fi
        
        if [ "${{ needs.security-analysis.result }}" = "success" ]; then
          echo "✓ Security checks completed"
        else
          echo "⚠️ Review security findings"
        fi
        
        echo ""
        echo "=========================================="
